<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>родрооро┐ро┤рпН ро╡ро┐ро╡роЪро╛роп роЙродро╡ро┐ропро╛ро│ро░рпН</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #2e7d32;
      text-align: center;
    }
    #chat-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #chat-output {
      height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .bot-message {
      background-color: #e8f5e9;
      padding: 8px 12px;
      border-radius: 15px;
      margin-bottom: 8px;
      display: inline-block;
      max-width: 80%;
    }
    .user-message {
      background-color: #bbdefb;
      padding: 8px 12px;
      border-radius: 15px;
      margin-bottom: 8px;
      display: inline-block;
      max-width: 80%;
      float: right;
    }
    #user-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    button {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 5px;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #1b5e20;
    }
    #controls {
      display: flex;
      justify-content: space-between;
    }
    #status {
      text-align: center;
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.3);
      border-radius: 50%;
      border-top-color: #2e7d32;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <!-- ResponsiveVoice TTS -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=UnNPAjMe"></script>
</head>
<body>
  <h1>ро╡ро┐ро╡роЪро╛ропро┐ роЙродро╡ро┐ роЪро╛роЯрпНрокро╛роЯрпН</h1>
  <h2>ЁЯМ╛ роЙроЩрпНроХро│рпН ро╡ропро▓ро┐ройрпН родроХро╡ро▓рпНроХро│рпИрокрпН рокро▒рпНро▒ро┐ роХрпЗро│рпБроЩрпНроХро│рпН</h2>
  
  <div id="chat-container">
    <div id="chat-output"></div>
    <input type="text" id="user-input" placeholder="родрооро┐ро┤ро┐ро▓рпН роЙроЩрпНроХро│рпН роХрпЗро│рпНро╡ро┐ропрпИ роЗроЩрпНроХрпЗ родроЯрпНроЯроЪрпНроЪрпБ роЪрпЖропрпНропро╡рпБроорпН..." onkeypress="handleKeyPress(event)">
    <div id="controls">
      <button id="send-btn" onclick="sendMessage()">роЕройрпБрокрпНрокрпБ</button>
      <button id="mic-btn" onclick="startListening()">ЁЯОд рокрпЗроЪрпБ</button>
      <button id="fetch-btn" onclick="fetchFieldDatas()">ро╡ропро▓рпН родро░ро╡рпБроХро│рпИрокрпН рокрпЖро▒рпБроХ</button>
    </div>
    <div id="status">родропро╛ро░ро╛роХ</div>
  </div>

<script>
// Configuration
const GEMINI_API_KEY = 'AIzaSyCozY_9cxmp9P-xaWPFlpCLRLRKGBBisjc';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
const BACKEND_API_URL = 'http://127.0.0.1:5000/field-datas';

// Global variables
let farmData = null;
let isProcessing = false;

// Speech Synthesis using ResponsiveVoice
function speakInTamil(text) {
  if (!text || typeof text !== 'string' || text.trim() === '') return;

  const tamilText = convertNumbersToTamil(text);

  try {
    responsiveVoice.speak(tamilText, "Tamil Female", {
      onstart: () => console.log("Speech started"),
      onend: () => console.log("Speech completed"),
      onerror: (error) => {
        console.error("Speech error:", error);
        updateStatus("рокрпЗроЪрпНроЪрпБ ро╡рпЖро│ро┐ропрпАроЯрпБ родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ");
      }
    });
  } catch (err) {
    console.error('ResponsiveVoice TTS failed:', err);
    updateStatus("рокрпЗроЪрпНроЪрпБ ро╡рпЖро│ро┐ропрпАроЯрпБ родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ");
  }
}

// Tamil number conversion
const tamilNumbers = {
  '1': 'роТройрпНро▒рпБ', '2': 'роЗро░рогрпНроЯрпБ', '3': 'роорпВройрпНро▒рпБ', '4': 'роиро╛ройрпНроХрпБ',
  '5': 'роРроирпНродрпБ', '6': 'роЖро▒рпБ', '7': 'роПро┤рпБ', '8': 'роОроЯрпНроЯрпБ',
  '9': 'роТройрпНрокродрпБ', '0': 'рокрпВроЬрпНропроорпН', '10': 'рокродрпНродрпБ',
  '100': 'роирпВро▒рпБ', '1000': 'роЖропро┐ро░роорпН'
};

function convertNumbersToTamil(text) {
  return text.replace(/\d+/g, match => {
    if (tamilNumbers[match]) return tamilNumbers[match];
    if (match.length > 1) return match.split('').map(d => tamilNumbers[d] || d).join(' ');
    return tamilNumbers[match] || match;
  });
}

// Chat display
function addUserMessage(message) {
  const chatOutput = document.getElementById('chat-output');
  const msg = document.createElement('div');
  msg.className = 'user-message';
  msg.textContent = message;
  chatOutput.appendChild(msg);
  chatOutput.scrollTop = chatOutput.scrollHeight;
}

function addBotMessage(message) {
  const chatOutput = document.getElementById('chat-output');
  const msg = document.createElement('div');
  msg.className = 'bot-message';
  msg.textContent = message.replace(/\*\*/g, '');
  chatOutput.appendChild(msg);
  chatOutput.scrollTop = chatOutput.scrollHeight;
  speakInTamil(msg.textContent);
}

function updateStatus(message) {
  const el = document.getElementById('status');
  el.innerHTML = message.includes("...") ? `<span class="loading"></span> ${message}` : message;
}

function disableButtons(disable) {
  document.getElementById('send-btn').disabled = disable;
  document.getElementById('mic-btn').disabled = disable;
  document.getElementById('fetch-btn').disabled = disable;
}

// Voice input - FIXED
function startListening() {
  if (isProcessing) return;

  addBotMessage("роиро╛ройрпН роХрпЗроЯрпНроХро┐ро▒рпЗройрпН... роЙроЩрпНроХро│рпН роХрпЗро│рпНро╡ро┐ропрпИрокрпН рокрпЗроЪрпБроЩрпНроХро│рпН.");
  updateStatus("роХрпЗроЯрпНроХро┐ро▒родрпБ...");
  disableButtons(true);

  if (!('webkitSpeechRecognition' in window)) {
    addBotMessage("рооройрпНройро┐роХрпНроХро╡рпБроорпН, роЙроЩрпНроХро│рпН роЙро▓ро╛ро╡ро┐ рокрпЗроЪрпНроЪрпБ роЕроЩрпНроХрпАроХро╛ро░родрпНродрпИ роЖродро░ро┐роХрпНроХро╡ро┐ро▓рпНро▓рпИ.");
    updateStatus("рокро┐ро┤рпИ: роЙро▓ро╛ро╡ро┐ роЖродро░ро╡рпБ роЗро▓рпНро▓рпИ");
    disableButtons(false);
    return;
  }

  try {
    recognition.onstart = () => {
  console.log("Speech recognition started");
};

    recognition.lang = 'ta-IN';
    recognition.interimResults = false;

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById('user-input').value = transcript;
      updateStatus("роХрпЗро│рпНро╡ро┐ рокрпЖро▒рокрпНрокроЯрпНроЯродрпБ");
      sendMessage();
    };

    recognition.onerror = function(event) {
      console.error("Speech Recognition Error:", event.error);
      if (event.error === 'audio-capture') {
        addBotMessage("роорпИроХрпНро░рпЛроГрокрпЛройрпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ. родропро╡рпБроЪрпЖропрпНродрпБ роорпИроХрпНро░рпЛроГрокрпЛройрпН роЕройрпБроородро┐ ро╡ро┤роЩрпНроХро╡рпБроорпН.");
        updateStatus("рокро┐ро┤рпИ: роорпИроХрпНро░рпЛроГрокрпЛройрпН роЗро▓рпНро▓рпИ");
      } else {
        addBotMessage("рокро┐ро┤рпИ: " + event.error);
        updateStatus("рокро┐ро┤рпИ: " + event.error);
      }
      disableButtons(false);
    };

    recognition.onend = function() {
      if (!isProcessing) {
        updateStatus("родропро╛ро░ро╛роХ");
        disableButtons(false);
      }
    };

    recognition.start();
  } catch (err) {
    console.error("Recognition Error:", err);
    addBotMessage("рокрпЗроЪрпНроЪрпБ роЕроЩрпНроХрпАроХро╛ро░роорпН родрпБро╡роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. родропро╡рпБроЪрпЖропрпНродрпБ роЙро▓ро╛ро╡ро┐ роЕройрпБроородро┐ропрпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.");
    updateStatus("рокро┐ро┤рпИ: рокрпЗроЪрпНроЪрпБ роЕроЩрпНроХрпАроХро╛ро░роорпН родрпЛро▓рпНро╡ро┐");
    disableButtons(false);
  }
}

// Input handling
function handleKeyPress(event) {
  if (event.key === 'Enter' && !isProcessing) {
    sendMessage();
  }
}

function sendMessage() {
  if (isProcessing) return;

  const input = document.getElementById('user-input');
  const msg = input.value.trim();
  if (msg === '') return;

  addUserMessage(msg);
  processUserQuery(msg);
  input.value = '';
}

// Field data fetch
async function fetchFieldDatas() {
  const token = localStorage.getItem("idToken");
  updateStatus("ро╡ропро▓рпН родро░ро╡рпБроХро│рпИрокрпН рокрпЖро▒рпБроХро┐ро▒родрпБ...");
  disableButtons(true);

  if (!token) {
    addBotMessage("роЙро│рпНроирпБро┤рпИро╡рпБ роЪро╛ройрпНро▒ро┐родро┤рпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ.");
    updateStatus("рокро┐ро┤рпИ: роЪро╛ройрпНро▒ро┐родро┤рпН роЗро▓рпНро▓рпИ");
    disableButtons(false);
    return;
  }

  try {
    const res = await fetch(BACKEND_API_URL, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    if (data.success && data.fields) {
      farmData = data.fields;
      localStorage.setItem("farmDataTemp", JSON.stringify(data.fields));
      addBotMessage("ро╡ропро▓рпН родро░ро╡рпБроХро│рпН рокрпЖро▒рокрпНрокроЯрпНроЯродрпБ! роХрпЗро│рпНро╡ро┐роХро│рпН роХрпЗроЯрпНроХро▓ро╛роорпН.");
      updateStatus("родропро╛ро░рпН");
    } else {
      throw new Error(data.message || "родро░ро╡рпБ роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ");
    }
  } catch (err) {
    console.error("Fetch Error:", err);
    addBotMessage("родро░ро╡рпБ рокрпЖро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ: " + err.message);
    updateStatus("рокро┐ро┤рпИ");
  } finally {
    disableButtons(false);
  }
}

// Gemini call
async function processUserQuery(query) {
  if (isProcessing) return;
  isProcessing = true;
  updateStatus("роЪрпЖропро▓ро╛роХрпНроХроорпН...");
  disableButtons(true);

  if (!farmData) {
    addBotMessage("роорпБродро▓ро┐ро▓рпН 'ро╡ропро▓рпН родро░ро╡рпБроХро│рпИрокрпН рокрпЖро▒рпБроХ' рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.");
    updateStatus("родро░ро╡рпБ роЗро▓рпНро▓рпИ");
    isProcessing = false;
    disableButtons(false);
    return;
  }

  try {
   const prompt = `
роирпАроЩрпНроХро│рпН роТро░рпБ роЕро▒ро┐ро╡ро╛ро│ро┐ ро╡ро┐ро╡роЪро╛роп роЙродро╡ро┐ропро╛ро│ро░рпН. рокро┐ройрпНро╡ро░рпБроорпН JSON родро░ро╡рпБроХро│рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐, ро╡ро┐ро╡роЪро╛ропро┐ропро┐ройрпН роХрпЗро│рпНро╡ро┐роХрпНроХрпБ родрпЖро│ро┐ро╡ро╛рой, рокропройрпБро│рпНро│ рокродро┐ро▓рпИ родрооро┐ро┤ро┐ро▓рпН роЕро│ро┐роХрпНроХро╡рпБроорпН.

ро╡ропро▓рпН родро░ро╡рпБ:
${JSON.stringify(farmData, null, 2)}

ро╡ро┐ро╡роЪро╛ропро┐ропро┐ройрпН роХрпЗро│рпНро╡ро┐:
${query}

рокродро┐ро▓рпН родро░рпБроорпН ро╡ро┐родро┐роорпБро▒рпИроХро│рпН:
1. роОро│ро┐роп рооро▒рпНро▒рпБроорпН родрпЖро│ро┐ро╡ро╛рой родрооро┐ро┤ро┐ро▓рпН рокродро┐ро▓ро│ро┐роХрпНроХро╡рпБроорпН.
2. родрпКро┤ро┐ро▓рпНроирпБроЯрпНрок роЪрпКро▒рпНроХро│рпИ родро╡ро┐ро░рпНроХрпНроХро╡рпБроорпН.
3. ро╡ро┐ро╡роЪро╛ропро┐ропро┐ройрпН роХрпЗро│рпНро╡ро┐роХрпНроХрпБ роирпЗро░роЯро┐ропро╛роХ рокродро┐ро▓ро│ро┐роХрпНроХро╡рпБроорпН.
4. родрпЗро╡рпИрокрпНрокроЯрпНроЯро╛ро▓рпН ро╡ро┐ро│роХрпНроХроЩрпНроХро│рпЛроЯрпБ роЪро┐роХро┐роЪрпНроЪрпИ роЕро▓рпНро▓родрпБ рокро░ро┐роирпНродрпБро░рпИроХро│рпИ роХрпВро▒ро╡рпБроорпН.
5. ро╡ропро▓рпН родро░ро╡рпБроХро│рпИроХрпН роХро╡ройрооро╛роХ роЖро░ро╛ропрпНроирпНродрпБ рокродро┐ро▓ро│ро┐роХрпНроХро╡рпБроорпН (роО.роХро╛., NPK роЕро│ро╡рпБроХро│рпН, роиро┐ро▓роорпН ро╡роХрпИ, роИро░рокрпНрокродроорпН).
6. ро╡ро┐ро╡роЪро╛ропро┐ропро┐ройрпН роХрпЗро│рпНро╡ро┐ 'роОройрпН NPK роиро┐ро▓рпИ роОройрпНрой?' роОройрпНро▒ро╛ро▓рпН, родро░ро╡ро┐ро▓ро┐ро░рпБроирпНродрпБ NPK роородро┐рокрпНрокрпБроХро│рпИ роОроЯрпБродрпНродрпБроХрпНроХрпКрогрпНроЯрпБ рокрпБро░ро┐ропрпБроорпН ро╡роХрпИропро┐ро▓рпН родрооро┐ро┤ро┐ро▓рпН ро╡ро┐ро╡ро░ро┐роХрпНроХро╡рпБроорпН.
7. роХрпЗро│рпНро╡ро┐ 'роиро╛ройрпН родроХрпНроХро╛ро│ро┐ ро╡ро│ро░рпНроХрпНроХро▓ро╛рооро╛?' рокрпЛройрпНро▒родро╛ропро┐ройрпН, родро░ро╡ро┐ройрпН роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН (роорогрпНрогро┐ройрпН ро╡роХрпИ, NPK роЕро│ро╡рпБ, роИро░рокрпНрокродроорпН рокрпЛройрпНро▒ро╡рпИ) рокро░ро┐роирпНродрпБро░рпИ роЪрпЖропрпНропро╡рпБроорпН.
8. рокродро┐ро▓рпН 2тАУ3 ро╡ро╛роХрпНроХро┐ропроЩрпНроХро│ро┐ро▓рпН роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.
9. роОрогрпНроХро│рпН родрооро┐ро┤рпН ро╡ро╛ро░рпНродрпНродрпИроХро│ро┐ро▓рпН рооро╛ро▒рпНро▒рокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН (роО.роХро╛., "3" тЖТ "роорпВройрпНро▒рпБ").
10. рокродро┐ро▓рпН родрооро┐ро┤ро┐ро▓рпН роороЯрпНроЯрпБроорпЗ роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.
`;

    const response = await callGeminiAPI(prompt);
    addBotMessage(response);
    updateStatus("родропро╛ро░рпН");
  } catch (error) {
    console.error("Gemini Error:", error);
    addBotMessage("рокро┐ро┤рпИ: рокродро┐ро▓рпИ рокрпЖро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
    updateStatus("рокро┐ро┤рпИ");
  } finally {
    isProcessing = false;
    disableButtons(false);
  }
}

// Gemini API call
async function callGeminiAPI(prompt) {
  updateStatus("роЬрпЖрооро┐ройро┐ AI-роР роЕрогрпБроХрпБроХро┐ро▒родрпБ...");
  const res = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }]
    })
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.error?.message || "Gemini API рокро┐ро┤рпИ");
  return data.candidates?.[0]?.content?.parts?.[0]?.text || "рокродро┐ро▓рпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ";
}

// Initial welcome message
window.onload = function() {
  addBotMessage("ро╡рогроХрпНроХроорпН! роиро╛ройрпН роЙроЩрпНроХро│рпН ро╡ро┐ро╡роЪро╛роп роЙродро╡ро┐ропро╛ро│ро░рпН. роЙроЩрпНроХро│рпН ро╡ропро▓рпНроХро│рпН рокро▒рпНро▒ро┐роп родроХро╡ро▓рпНроХро│рпИрокрпН рокрпЖро▒ 'ро╡ропро▓рпН родро░ро╡рпБроХро│рпИрокрпН рокрпЖро▒рпБроХ' рокрпКродрпНродро╛ройрпИроХрпН роХро┐ро│ро┐роХрпН роЪрпЖропрпНропро╡рпБроорпН.");
};
</script>

</body>
</html>